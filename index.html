<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scooch — TikTok Affiliate Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: #0B0E14;
    color: #C9D1D9;
    min-height: 100vh;
    overflow-x: hidden;
  }
  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: #161B22; }
  ::-webkit-scrollbar-thumb { background: #30363D; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #484F58; }
  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
  }
  /* Glow accent */
  .glow-line {
    height: 2px;
    background: linear-gradient(90deg, transparent, #E94560, #6C5CE7, transparent);
    margin-bottom: 32px;
    opacity: 0.6;
  }
  /* Pill buttons */
  .pill-group {
    display: inline-flex;
    background: #12161E;
    border-radius: 10px;
    border: 1px solid #1E2533;
    overflow: hidden;
  }
  .pill-btn {
    padding: 8px 16px;
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: #6B7280;
    background: transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .pill-btn.active { color: #fff; }
  .pill-btn.active.red { background: #E94560; }
  .pill-btn.active.purple { background: #6C5CE7; }
  .pill-btn:hover:not(.active) { color: #9CA3AF; }
  /* Cards */
  .card {
    background: #12161E;
    border: 1px solid #1E2533;
    border-radius: 14px;
    padding: 20px;
  }
  .card-glow {
    position: relative;
  }
  .card-glow::before {
    content: '';
    position: absolute;
    top: -1px; left: -1px; right: -1px; bottom: -1px;
    border-radius: 15px;
    background: linear-gradient(135deg, rgba(233,69,96,0.15), transparent 50%);
    z-index: -1;
  }
  /* Toggle pills */
  .toggle-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    border: 2px solid;
  }
  .toggle-pill .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }
  /* Import area */
  .import-textarea {
    width: 100%;
    height: 120px;
    background: #0B0E14;
    border: 1px solid #1E2533;
    border-radius: 10px;
    padding: 12px;
    color: #C9D1D9;
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    resize: vertical;
  }
  .import-textarea:focus { outline: none; border-color: #E94560; }
  .import-input {
    background: #0B0E14;
    border: 1px solid #1E2533;
    border-radius: 8px;
    padding: 8px 12px;
    color: #C9D1D9;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    width: 150px;
  }
  .import-input:focus { outline: none; border-color: #E94560; }
  /* Action buttons */
  .btn-primary {
    background: #E94560;
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 10px 22px;
    cursor: pointer;
    font-weight: 700;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    transition: transform 0.1s;
  }
  .btn-primary:hover { transform: scale(1.02); }
  .btn-primary:active { transform: scale(0.98); }
  .btn-ghost {
    background: transparent;
    color: #6B7280;
    border: 1px solid #1E2533;
    border-radius: 10px;
    padding: 10px 18px;
    cursor: pointer;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    transition: border-color 0.2s;
  }
  .btn-ghost:hover { border-color: #484F58; }
  /* Data table */
  .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .data-table th {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid #1E2533;
    color: #6B7280;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .data-table td {
    padding: 8px 12px;
    border-bottom: 1px solid #111620;
  }
  .data-table tr:nth-child(even) { background: rgba(255,255,255,0.015); }
  .data-table a { color: #0A84FF; text-decoration: none; }
  .data-table a:hover { text-decoration: underline; }
  /* Stat card */
  .stat-value {
    font-size: 26px;
    font-weight: 700;
    letter-spacing: -0.5px;
    line-height: 1.1;
  }
  .stat-label {
    font-size: 11px;
    color: #6B7280;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 4px;
  }
  /* Select dropdown */
  .select-dark {
    background: #12161E;
    border: 1px solid #1E2533;
    border-radius: 8px;
    padding: 7px 10px;
    color: #C9D1D9;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
  }
  .select-dark:focus { outline: none; border-color: #6C5CE7; }
  /* Responsive */
  @media (max-width: 768px) {
    .controls-row { flex-direction: column !important; }
    .stat-grid { grid-template-columns: repeat(2, 1fr) !important; }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;
const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = Recharts;

const COLORS = [
  "#E94560", "#00B894", "#6C5CE7", "#FDCB6E", "#00CEC9",
  "#FF6B6B", "#A29BFE", "#FD79A8", "#55E6C1", "#5F27CD",
  "#F8A5C2", "#63CDDA", "#F19066", "#786FA6", "#3DC1D3",
];

const METRICS = [
  { key: "gmv", label: "GMV ($)", format: (v) => `$${v.toFixed(2)}` },
  { key: "orders", label: "Orders", format: (v) => v.toString() },
  { key: "items_sold", label: "Items Sold", format: (v) => v.toString() },
  { key: "commission", label: "Commission ($)", format: (v) => `$${v.toFixed(2)}` },
];

const parseMoney = (val) => {
  if (!val) return 0;
  if (typeof val === "number") return val;
  return parseFloat(String(val).replace(/[$,]/g, "")) || 0;
};

const parseNum = (val) => {
  if (!val) return 0;
  return parseInt(String(val).replace(/,/g, ""), 10) || 0;
};

const parseTSV = (text) => {
  const lines = text.trim().split("\n").filter((l) => l.trim());
  if (lines.length < 2) return [];
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split("\t");
    if (cols.length < 12) continue;
    rows.push({
      video_title: cols[0]?.trim() || "",
      video_id: cols[1]?.trim() || "",
      post_date: cols[2]?.trim() || "",
      video_link: cols[3]?.trim() || "",
      creator: cols[4]?.trim() || "",
      product: cols[5]?.trim() || "",
      product_id: cols[6]?.trim() || "",
      gmv: parseMoney(cols[7]),
      orders: parseNum(cols[8]),
      aov: parseMoney(cols[9]),
      avg_gmv_customer: parseMoney(cols[10]),
      items_sold: parseNum(cols[11]),
      refunds: parseMoney(cols[12]),
      items_refunded: parseNum(cols[13]),
      commission: parseMoney(cols[14]),
      flat_fee: parseMoney(cols[15]),
    });
  }
  return rows;
};

const tiktokUrl = (creator, videoId) =>
  `https://www.tiktok.com/@${creator.replace(/^@/,'')}/video/${videoId}`;

const SAMPLE_DATA = [
  {
    week: "01/03/2026",
    records: [
      { video_id: "7523323960465820983", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 115.69, orders: 3, items_sold: 3, commission: 18.93, video_title: "The people you least suspect are the craziest ones" },
      { video_id: "7493369582930119982", creator: "caine.the.pain", product: "mWorks! Tech Cleaning Kit", gmv: 45.93, orders: 7, items_sold: 7, commission: 13.78, video_title: "Amazing product to clean those nasty electronic screens!" },
      { video_id: "7569650477990792461", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 39.99, orders: 1, items_sold: 1, commission: 10.00, video_title: "Replying to @Mr. Steal Ur Jutsu" },
      { video_id: "7581614440697629966", creator: "ashley.hall92", product: "Wingmate Hidden Wallet Case (13/14)", gmv: 35.71, orders: 1, items_sold: 1, commission: 10.71, video_title: "A mom hack I didn't know I needed" },
      { video_id: "7582432743384976695", creator: "allisonkay1989", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 35.71, orders: 1, items_sold: 1, commission: 0, video_title: "Military-grade protection + hidden wallet? Yes please." },
      { video_id: "7571566010537463053", creator: "scottpolderman", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 33.83, orders: 1, items_sold: 1, commission: 7.44, video_title: "#iphonecase #iphone #iphonetips" },
      { video_id: "7548457100486167863", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 32.14, orders: 1, items_sold: 1, commission: 8.93, video_title: "This phone case has a secret wallet inside" },
      { video_id: "7588289072938978615", creator: "mai.tts.journey", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 27.99, orders: 1, items_sold: 1, commission: 0, video_title: "What a genius idea!" },
      { video_id: "7491757544793181486", creator: "lolomommaof2", product: "Wingmate Hidden Wallet Case (13/14)", gmv: 26.78, orders: 1, items_sold: 1, commission: 6.70, video_title: "A hard phone case and card holder! 10 out of 10" },
      { video_id: "7570949603084881166", creator: "the_promized_one", product: "Wingmate Hidden Wallet Case (Galaxy S24/S25)", gmv: 26.78, orders: 1, items_sold: 1, commission: 8.03, video_title: "The all-in-one solution for people who hate bulky wallets" },
      { video_id: "7515537310100901162", creator: "sourcedbysky", product: "Scooch Wingback Pop Out Kickstand", gmv: 14.99, orders: 1, items_sold: 1, commission: 0, video_title: "This is a canon event" },
      { video_id: "7567845692786494751", creator: "everybodyhateskris", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 14.99, orders: 1, items_sold: 1, commission: 9.00, video_title: "#ad" },
      { video_id: "7574611819059334455", creator: "lolomommaof2", product: "Wingmate Hidden Wallet Case (13/14)", gmv: 0, orders: 0, items_sold: 0, commission: 0, video_title: "The phone case that has people giving up carrying a wallet!" },
    ],
  },
  {
    week: "01/10/2026",
    records: [
      { video_id: "7523323960465820983", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 219.94, orders: 6, items_sold: 6, commission: 48.40, video_title: "The people you least suspect are the craziest ones" },
      { video_id: "7582432743384976695", creator: "allisonkay1989", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 39.99, orders: 1, items_sold: 1, commission: 8.80, video_title: "Military-grade protection + hidden wallet?" },
      { video_id: "7588445730478591263", creator: "itzansonn", product: "Moneymate Slim Wallet Case", gmv: 32.99, orders: 1, items_sold: 1, commission: 7.26, video_title: "Super Handy!" },
      { video_id: "7588289072938978615", creator: "mai.tts.journey", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 27.99, orders: 1, items_sold: 1, commission: 0, video_title: "What a genius idea!" },
      { video_id: "7587263474720410935", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (17/Air)", gmv: 24.99, orders: 1, items_sold: 1, commission: 8.80, video_title: "The hidden wallet phone case" },
      { video_id: "7493369582930119982", creator: "caine.the.pain", product: "mWorks! Tech Cleaning Kit", gmv: 13.98, orders: 2, items_sold: 2, commission: 3.08, video_title: "Amazing product to clean those nasty electronic screens!" },
      { video_id: "7502965590689189150", creator: "zeneyra2", product: "mWorks! Tech Cleaning Kit", gmv: 6.99, orders: 1, items_sold: 1, commission: 1.54, video_title: "Limpia la pantalla de tu computadora" },
    ],
  },
  {
    week: "01/17/2026",
    records: [
      { video_id: "7493369582930119982", creator: "caine.the.pain", product: "mWorks! Tech Cleaning Kit", gmv: 13.98, orders: 2, items_sold: 2, commission: 3.08, video_title: "Amazing product to clean those nasty electronic screens!" },
      { video_id: "7502965590689189150", creator: "zeneyra2", product: "mWorks! Tech Cleaning Kit", gmv: 6.99, orders: 1, items_sold: 1, commission: 1.54, video_title: "Limpia la pantalla de tu computadora" },
      { video_id: "7569650477990792461", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 0, orders: 0, items_sold: 0, commission: 0, video_title: "Replying to @Mr. Steal Ur Jutsu" },
      { video_id: "7570949603084881166", creator: "the_promized_one", product: "Wingmate Hidden Wallet Case (Galaxy S24/S25)", gmv: 0, orders: 0, items_sold: 0, commission: 0, video_title: "The all-in-one solution for people who hate bulky wallets" },
      { video_id: "7571566010537463053", creator: "scottpolderman", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 0, orders: 0, items_sold: 0, commission: 0, video_title: "#iphonecase #iphone #iphonetips" },
    ],
  },
  {
    week: "01/24/2026",
    records: [
      { video_id: "7493369582930119982", creator: "caine.the.pain", product: "mWorks! Tech Cleaning Kit", gmv: 38.06, orders: 4, items_sold: 4, commission: 8.80, video_title: "Amazing product to clean those nasty electronic screens!" },
      { video_id: "7548457100486167863", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 35.71, orders: 1, items_sold: 1, commission: 7.86, video_title: "This phone case has a secret wallet inside" },
      { video_id: "7587439290657951007", creator: "jess32145", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 25.50, orders: 1, items_sold: 1, commission: 7.48, video_title: "Tired of cracked screens and bulky wallets?" },
    ],
  },
  {
    week: "01/31/2026",
    records: [
      { video_id: "7523323960465820983", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 34.00, orders: 1, items_sold: 1, commission: 7.48, video_title: "The people you least suspect are the craziest ones" },
      { video_id: "7580218091083304206", creator: "endlessly.inspired", product: "Wingmate Hidden Wallet Case (13/14)", gmv: 33.20, orders: 1, items_sold: 1, commission: 0, video_title: "Best gift for your teen or college aged boy" },
      { video_id: "7493369582930119982", creator: "caine.the.pain", product: "mWorks! Tech Cleaning Kit", gmv: 12.48, orders: 2, items_sold: 2, commission: 2.74, video_title: "Amazing product to clean those nasty electronic screens!" },
    ],
  },
  {
    week: "02/07/2026",
    records: [
      { video_id: "7523323960465820983", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 53.79, orders: 2, items_sold: 2, commission: 15.13, video_title: "The people you least suspect are the craziest ones" },
      { video_id: "7548457100486167863", creator: "worldsgreatestchad", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 34.79, orders: 1, items_sold: 1, commission: 7.65, video_title: "This phone case has a secret wallet inside" },
      { video_id: "7522562671946911006", creator: "moe_couponing", product: "Wingmate Hidden Wallet Case (15/16)", gmv: 34.00, orders: 1, items_sold: 1, commission: 7.48, video_title: "Holds up to 4 cards and cash and has RFID protection" },
      { video_id: "7493369582930119982", creator: "caine.the.pain", product: "mWorks! Tech Cleaning Kit", gmv: 13.98, orders: 2, items_sold: 2, commission: 3.08, video_title: "Amazing product to clean those nasty electronic screens!" },
    ],
  },
];

function TikTokTracker() {
  const [weeksData, setWeeksData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeMetric, setActiveMetric] = useState("gmv");
  const [groupBy, setGroupBy] = useState("creator");
  const [hiddenLines, setHiddenLines] = useState(new Set());
  const [dateRange, setDateRange] = useState({ start: "", end: "" });
  const [showImport, setShowImport] = useState(false);
  const [importWeek, setImportWeek] = useState("");
  const [importText, setImportText] = useState("");
  const [importStatus, setImportStatus] = useState("");
  const [showTable, setShowTable] = useState(false);

  useEffect(() => {
    try {
      const stored = localStorage.getItem("scooch-tiktok-affiliate-data");
      if (stored) {
        setWeeksData(JSON.parse(stored));
      } else {
        setWeeksData(SAMPLE_DATA);
        localStorage.setItem("scooch-tiktok-affiliate-data", JSON.stringify(SAMPLE_DATA));
      }
    } catch {
      setWeeksData(SAMPLE_DATA);
    }
    setLoading(false);
  }, []);

  const saveData = useCallback((data) => {
    setWeeksData(data);
    try { localStorage.setItem("scooch-tiktok-affiliate-data", JSON.stringify(data)); } catch {}
  }, []);

  const handleImport = useCallback(() => {
    if (!importWeek || !importText.trim()) {
      setImportStatus("Need both a week ending date and pasted data.");
      return;
    }
    const rows = parseTSV(importText);
    if (rows.length === 0) {
      setImportStatus("Couldn't parse any rows. Copy from TikTok export (with headers) as tab-separated.");
      return;
    }
    const newWeek = {
      week: importWeek,
      records: rows.map((r) => ({
        video_id: r.video_id,
        creator: r.creator,
        product: r.product.length > 50 ? r.product.slice(0, 50) : r.product,
        gmv: r.gmv,
        orders: r.orders,
        items_sold: r.items_sold,
        commission: r.commission,
        video_title: r.video_title.length > 80 ? r.video_title.slice(0, 80) + "..." : r.video_title,
      })),
    };
    const existing = weeksData.filter((w) => w.week !== importWeek);
    const updated = [...existing, newWeek].sort((a, b) => new Date(a.week) - new Date(b.week));
    saveData(updated);
    setImportText("");
    setImportWeek("");
    setImportStatus(`Imported ${rows.length} videos for week ending ${importWeek}.`);
    setTimeout(() => setImportStatus(""), 3000);
  }, [importWeek, importText, weeksData, saveData]);

  const handleReset = useCallback(() => {
    saveData(SAMPLE_DATA);
    setHiddenLines(new Set());
    setDateRange({ start: "", end: "" });
  }, [saveData]);

  const handleExportCSV = useCallback(() => {
    const rows = [["Week","Creator","Video ID","Product","GMV","Orders","Items Sold","Commission"]];
    for (const wd of weeksData) {
      for (const r of wd.records) {
        rows.push([wd.week, r.creator, r.video_id, r.product, r.gmv, r.orders, r.items_sold, r.commission]);
      }
    }
    const csv = rows.map(r => r.map(v => `"${v}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "tiktok_affiliate_data.csv"; a.click();
    URL.revokeObjectURL(url);
  }, [weeksData]);

  const allWeeks = useMemo(() => weeksData.map((w) => w.week).sort((a, b) => new Date(a) - new Date(b)), [weeksData]);

  const filteredWeeks = useMemo(() => {
    return allWeeks.filter((w) => {
      const d = new Date(w);
      if (dateRange.start && d < new Date(dateRange.start)) return false;
      if (dateRange.end && d > new Date(dateRange.end)) return false;
      return true;
    });
  }, [allWeeks, dateRange]);

  const { chartData, lineKeys, lineLabels, colorMap } = useMemo(() => {
    const groups = {};
    for (const wd of weeksData) {
      for (const r of wd.records) {
        const key = groupBy === "creator" ? r.creator : r.video_id;
        const label = groupBy === "creator" ? r.creator : `${r.creator} — ${r.video_id.slice(-6)}`;
        if (!groups[key]) groups[key] = { label, weekData: {}, creator: r.creator };
        if (!groups[key].weekData[wd.week]) groups[key].weekData[wd.week] = 0;
        groups[key].weekData[wd.week] += r[activeMetric] || 0;
      }
    }
    const sortedKeys = Object.keys(groups).sort((a, b) => {
      const totalA = Object.values(groups[a].weekData).reduce((s, v) => s + v, 0);
      const totalB = Object.values(groups[b].weekData).reduce((s, v) => s + v, 0);
      return totalB - totalA;
    });
    const colorMap = {};
    sortedKeys.forEach((k, i) => { colorMap[k] = COLORS[i % COLORS.length]; });
    const chartData = filteredWeeks.map((week) => {
      const point = { week };
      for (const key of sortedKeys) {
        if (!hiddenLines.has(key)) {
          point[key] = groups[key].weekData[week] || 0;
        }
      }
      return point;
    });
    const lineLabels = {};
    sortedKeys.forEach((k) => { lineLabels[k] = groups[k].label; });
    return { chartData, lineKeys: sortedKeys, lineLabels, colorMap };
  }, [weeksData, filteredWeeks, activeMetric, groupBy, hiddenLines]);

  const metricInfo = METRICS.find((m) => m.key === activeMetric);

  const tableData = useMemo(() => {
    if (!showTable) return [];
    const rows = [];
    for (const wd of weeksData) {
      if (!filteredWeeks.includes(wd.week)) continue;
      for (const r of wd.records) {
        rows.push({ ...r, week: wd.week });
      }
    }
    return rows.sort((a, b) => b.gmv - a.gmv);
  }, [weeksData, filteredWeeks, showTable]);

  const totals = useMemo(() => {
    let gmv = 0, orders = 0, commission = 0, creators = new Set(), videos = new Set();
    for (const wd of weeksData) {
      if (!filteredWeeks.includes(wd.week)) continue;
      for (const r of wd.records) {
        gmv += r.gmv; orders += r.orders; commission += r.commission;
        creators.add(r.creator); videos.add(r.video_id);
      }
    }
    return { gmv, orders, commission, creators: creators.size, videos: videos.size };
  }, [weeksData, filteredWeeks]);

  if (loading) return <div style={{ padding: 60, textAlign: "center", color: "#6B7280" }}>Loading...</div>;

  return (
    <div style={{ maxWidth: 1200, margin: "0 auto", padding: "32px 24px" }}>
      {/* Header */}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 8, flexWrap: "wrap", gap: 16 }}>
        <div>
          <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
            <h1 style={{ fontSize: 28, fontWeight: 700, color: "#E94560", letterSpacing: -0.5 }}>
              TikTok Affiliate Tracker
            </h1>
            <span style={{ fontSize: 11, background: "#1E2533", color: "#6B7280", padding: "3px 10px", borderRadius: 6, fontWeight: 500 }}>
              SCOOCH
            </span>
          </div>
          <p style={{ color: "#484F58", fontSize: 14, marginTop: 4 }}>
            {weeksData.length} weeks · {weeksData.reduce((s, w) => s + w.records.length, 0)} records · {totals.creators} creators
          </p>
        </div>
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
          <button onClick={() => setShowImport(!showImport)}
            className={showImport ? "btn-primary" : "btn-ghost"}
            style={showImport ? {} : { color: "#E94560", borderColor: "#E9456033" }}>
            {showImport ? "✕ Close" : "+ Import Week"}
          </button>
          <button onClick={() => setShowTable(!showTable)} className="btn-ghost">
            {showTable ? "Hide Table" : "Data Table"}
          </button>
          <button onClick={handleExportCSV} className="btn-ghost">
            ↓ CSV
          </button>
        </div>
      </div>

      <div className="glow-line" />

      {/* Import Panel */}
      {showImport && (
        <div className="card" style={{ marginBottom: 20, borderColor: "#E9456033" }}>
          <h3 style={{ margin: "0 0 8px", color: "#E94560", fontSize: 16, fontWeight: 700 }}>Import Weekly Export</h3>
          <p style={{ color: "#484F58", fontSize: 13, margin: "0 0 14px" }}>
            Open TikTok export in Excel → Select all data including headers → Copy → Paste below
          </p>
          <div style={{ display: "flex", gap: 12, marginBottom: 12, alignItems: "center", flexWrap: "wrap" }}>
            <label style={{ color: "#6B7280", fontSize: 13 }}>Week ending:</label>
            <input type="text" placeholder="MM/DD/YYYY" value={importWeek}
              onChange={(e) => setImportWeek(e.target.value)} className="import-input" />
          </div>
          <textarea value={importText} onChange={(e) => setImportText(e.target.value)}
            placeholder="Paste tab-separated data here (with header row)..." className="import-textarea" />
          <div style={{ display: "flex", gap: 12, marginTop: 14, alignItems: "center", flexWrap: "wrap" }}>
            <button onClick={handleImport} className="btn-primary">Import Data</button>
            <button onClick={handleReset} className="btn-ghost">Reset to Sample</button>
            {importStatus && <span style={{ color: importStatus.includes("Imported") ? "#00B894" : "#E94560", fontSize: 13 }}>{importStatus}</span>}
          </div>
        </div>
      )}

      {/* Controls */}
      <div className="controls-row" style={{ display: "flex", gap: 14, marginBottom: 22, flexWrap: "wrap", alignItems: "center" }}>
        <div className="pill-group">
          {METRICS.map((m) => (
            <button key={m.key} onClick={() => setActiveMetric(m.key)}
              className={`pill-btn ${activeMetric === m.key ? "active red" : ""}`}>
              {m.label}
            </button>
          ))}
        </div>
        <div className="pill-group">
          {[{ key: "creator", label: "By Creator" }, { key: "video", label: "By Video" }].map((g) => (
            <button key={g.key} onClick={() => { setGroupBy(g.key); setHiddenLines(new Set()); }}
              className={`pill-btn ${groupBy === g.key ? "active purple" : ""}`}>
              {g.label}
            </button>
          ))}
        </div>
        <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
          <span style={{ color: "#484F58", fontSize: 13 }}>From</span>
          <select value={dateRange.start} onChange={(e) => setDateRange((d) => ({ ...d, start: e.target.value }))} className="select-dark">
            <option value="">All</option>
            {allWeeks.map((w) => <option key={w} value={w}>{w}</option>)}
          </select>
          <span style={{ color: "#484F58", fontSize: 13 }}>to</span>
          <select value={dateRange.end} onChange={(e) => setDateRange((d) => ({ ...d, end: e.target.value }))} className="select-dark">
            <option value="">All</option>
            {allWeeks.map((w) => <option key={w} value={w}>{w}</option>)}
          </select>
        </div>
      </div>

      {/* Stat Cards */}
      <div className="stat-grid" style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 12, marginBottom: 22 }}>
        {[
          { label: "Total GMV", value: `$${totals.gmv.toFixed(2)}`, color: "#00B894" },
          { label: "Orders", value: totals.orders, color: "#6C5CE7" },
          { label: "Commission", value: `$${totals.commission.toFixed(2)}`, color: "#FDCB6E" },
          { label: "Creators", value: totals.creators, color: "#00CEC9" },
          { label: "Weeks", value: filteredWeeks.length, color: "#E94560" },
        ].map((card) => (
          <div key={card.label} className="card" style={{ padding: "16px 18px" }}>
            <div className="stat-label">{card.label}</div>
            <div className="stat-value" style={{ color: card.color }}>{card.value}</div>
          </div>
        ))}
      </div>

      {/* Chart */}
      <div className="card card-glow" style={{ marginBottom: 20, padding: "20px 16px 10px" }}>
        <h3 style={{ margin: "0 0 14px", color: "#C9D1D9", fontSize: 15, fontWeight: 600 }}>
          {metricInfo.label} by {groupBy === "creator" ? "Creator" : "Video"} — Week over Week
        </h3>
        <ResponsiveContainer width="100%" height={360}>
          <LineChart data={chartData} margin={{ top: 5, right: 20, bottom: 5, left: 10 }}>
            <CartesianGrid strokeDasharray="3 3" stroke="#1E2533" />
            <XAxis dataKey="week" stroke="#484F58" fontSize={12} fontFamily="DM Sans" />
            <YAxis stroke="#484F58" fontSize={12} fontFamily="DM Sans" tickFormatter={metricInfo.format} />
            <Tooltip
              contentStyle={{ background: "#12161E", border: "1px solid #1E2533", borderRadius: 10, color: "#C9D1D9", fontSize: 13, fontFamily: "DM Sans" }}
              formatter={(value, name) => [metricInfo.format(value), lineLabels[name] || name]}
              labelStyle={{ color: "#E94560", fontWeight: 700, marginBottom: 4 }}
            />
            {lineKeys.filter((k) => !hiddenLines.has(k)).map((key) => (
              <Line key={key} type="monotone" dataKey={key} stroke={colorMap[key]} strokeWidth={2.5}
                dot={{ r: 4, fill: colorMap[key], strokeWidth: 0 }} activeDot={{ r: 6 }} connectNulls={false} name={key} />
            ))}
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Toggle Legend */}
      <div className="card" style={{ marginBottom: 20, padding: 16 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
          <h3 style={{ margin: 0, color: "#C9D1D9", fontSize: 13, fontWeight: 600 }}>
            Toggle {groupBy === "creator" ? "Creators" : "Videos"}
          </h3>
          <div style={{ display: "flex", gap: 8 }}>
            <button onClick={() => setHiddenLines(new Set())} className="btn-ghost" style={{ padding: "4px 12px", fontSize: 11, color: "#00B894" }}>Show All</button>
            <button onClick={() => setHiddenLines(new Set(lineKeys))} className="btn-ghost" style={{ padding: "4px 12px", fontSize: 11, color: "#E94560" }}>Hide All</button>
          </div>
        </div>
        <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
          {lineKeys.map((key) => {
            const isHidden = hiddenLines.has(key);
            return (
              <button key={key} onClick={() => {
                const next = new Set(hiddenLines);
                isHidden ? next.delete(key) : next.add(key);
                setHiddenLines(next);
              }}
                className="toggle-pill"
                style={{
                  borderColor: colorMap[key],
                  background: isHidden ? "transparent" : colorMap[key] + "18",
                  color: isHidden ? "#484F58" : "#C9D1D9",
                  opacity: isHidden ? 0.35 : 1,
                }}>
                <span className="dot" style={{ background: colorMap[key] }} />
                {lineLabels[key]}
              </button>
            );
          })}
        </div>
      </div>

      {/* Data Table */}
      {showTable && (
        <div className="card" style={{ overflowX: "auto" }}>
          <h3 style={{ margin: "0 0 14px", color: "#C9D1D9", fontSize: 15, fontWeight: 600 }}>All Records</h3>
          <table className="data-table">
            <thead>
              <tr>
                {["Week", "Creator", "Video", "Product", "GMV", "Orders", "Items", "Commission"].map((h) => (
                  <th key={h}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {tableData.map((r, i) => (
                <tr key={i}>
                  <td style={{ color: "#E94560", fontWeight: 600, whiteSpace: "nowrap" }}>{r.week}</td>
                  <td>{r.creator}</td>
                  <td style={{ fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>
                    <a href={tiktokUrl(r.creator, r.video_id)} target="_blank" rel="noopener noreferrer">
                      ...{r.video_id.slice(-8)}
                    </a>
                  </td>
                  <td style={{ maxWidth: 200, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{r.product}</td>
                  <td style={{ color: "#00B894", fontWeight: 600 }}>${r.gmv.toFixed(2)}</td>
                  <td>{r.orders}</td>
                  <td>{r.items_sold}</td>
                  <td style={{ color: "#FDCB6E" }}>${r.commission.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Footer */}
      <div style={{ textAlign: "center", marginTop: 32, color: "#2D333B", fontSize: 12 }}>
        Scooch · TikTok Affiliate Performance Tracker · Data persists in your browser
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<TikTokTracker />);
</script>
</body>
</html>
